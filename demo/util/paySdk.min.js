(function(T,B){typeof exports=="object"&&typeof module<"u"?module.exports=B():typeof define=="function"&&define.amd?define(B):(T=typeof globalThis<"u"?globalThis:T||self,T.HFWebsocket=B())})(this,function(){"use strict";const T={POSTBE_URL:"http://jpostbe.huifutest.com/api/jpostbeApi/autoTrack/save",POSTBE_APP_KEY:"78b0d03c2c9390ee38a30c254fee1af0",POSTBE_APP_TOKEN:"app-99ae7483-3713-4fb7-88da-90f2904b1e8b",WEBSOCKET_URL:"ws://ws.huifutest.com:6001/ws?token=",BASE_URL:"http://iotpush.huifutest.com"},B={POSTBE_URL:"https://jua.cloudpnr.com/api/jpostbeApi/autoTrack/save",POSTBE_APP_KEY:"a12815b9c671a70f671759f489d076a8",POSTBE_APP_TOKEN:"app-f59730c3-5d2e-45f9-ac2b-fbb4dc53c253",WEBSOCKET_URL:"wss://ws.cloudpnr.com/ws?token=",BASE_URL:"https://iotpush.cloudpnr.com"},E=i=>i===!0?T:B,F="0.0.1";class I{static post(e,s){return new Promise((r,l)=>{try{let a=new XMLHttpRequest;a&&(a.withCredentials=!1,a.onreadystatechange=function(){if(a.readyState===4)if(a.status>=200&&a.status<300||a.status==304){const f=JSON.parse(a.responseText);r(f)}else l(a.status)},a.open("POST",e,!0),a.setRequestHeader("Content-type","application/json; charset=UTF-8"),a.send(JSON.stringify(s)||null))}catch{l("\u8BF7\u6C42\u5F02\u5E38")}})}}I.getWsToken="/ws-mgnt-ser/ws_token";var A=A||function(i,e){var s={},r=s.lib={},l=function(){},a=r.Base={extend:function(t){l.prototype=this;var o=new l;return t&&o.mixIn(t),o.hasOwnProperty("init")||(o.init=function(){o.$super.init.apply(this,arguments)}),o.init.prototype=o,o.$super=this,o},create:function(){var t=this.extend();return t.init.apply(t,arguments),t},init:function(){},mixIn:function(t){for(var o in t)t.hasOwnProperty(o)&&(this[o]=t[o]);t.hasOwnProperty("toString")&&(this.toString=t.toString)},clone:function(){return this.init.prototype.extend(this)}},f=r.WordArray=a.extend({init:function(t,o){t=this.words=t||[],this.sigBytes=o!=e?o:4*t.length},toString:function(t){return(t||h).stringify(this)},concat:function(t){var o=this.words,c=t.words,n=this.sigBytes;if(t=t.sigBytes,this.clamp(),n%4)for(var u=0;u<t;u++)o[n+u>>>2]|=(c[u>>>2]>>>24-8*(u%4)&255)<<24-8*((n+u)%4);else if(65535<c.length)for(u=0;u<t;u+=4)o[n+u>>>2]=c[u>>>2];else o.push.apply(o,c);return this.sigBytes+=t,this},clamp:function(){var t=this.words,o=this.sigBytes;t[o>>>2]&=4294967295<<32-8*(o%4),t.length=i.ceil(o/4)},clone:function(){var t=a.clone.call(this);return t.words=this.words.slice(0),t},random:function(t){for(var o=[],c=0;c<t;c+=4)o.push(4294967296*i.random()|0);return new f.init(o,t)}}),p=s.enc={},h=p.Hex={stringify:function(t){var o=t.words;t=t.sigBytes;for(var c=[],n=0;n<t;n++){var u=o[n>>>2]>>>24-8*(n%4)&255;c.push((u>>>4).toString(16)),c.push((u&15).toString(16))}return c.join("")},parse:function(t){for(var o=t.length,c=[],n=0;n<o;n+=2)c[n>>>3]|=parseInt(t.substr(n,2),16)<<24-4*(n%8);return new f.init(c,o/2)}},d=p.Latin1={stringify:function(t){var o=t.words;t=t.sigBytes;for(var c=[],n=0;n<t;n++)c.push(String.fromCharCode(o[n>>>2]>>>24-8*(n%4)&255));return c.join("")},parse:function(t){for(var o=t.length,c=[],n=0;n<o;n++)c[n>>>2]|=(t.charCodeAt(n)&255)<<24-8*(n%4);return new f.init(c,o)}},S=p.Utf8={stringify:function(t){try{return decodeURIComponent(escape(d.stringify(t)))}catch{throw Error("Malformed UTF-8 data")}},parse:function(t){return d.parse(unescape(encodeURIComponent(t)))}},x=r.BufferedBlockAlgorithm=a.extend({reset:function(){this._data=new f.init,this._nDataBytes=0},_append:function(t){typeof t=="string"&&(t=S.parse(t)),this._data.concat(t),this._nDataBytes+=t.sigBytes},_process:function(t){var o=this._data,c=o.words,n=o.sigBytes,u=this.blockSize,w=n/(4*u),w=t?i.ceil(w):i.max((w|0)-this._minBufferSize,0);t=w*u,n=i.min(4*t,n);var g=0;if(t){for(g=0;g<t;g+=u)this._doProcessBlock(c,g);g=c.splice(0,t),o.sigBytes-=n}return new f.init(g,n)},clone:function(){var t=a.clone.call(this);return t._data=this._data.clone(),t},_minBufferSize:0});r.Hasher=x.extend({cfg:a.extend(),init:function(t){this.cfg=this.cfg.extend(t),this.reset()},reset:function(){x.reset.call(this),this._doReset()},update:function(t){return this._append(t),this._process(),this},finalize:function(t){return t&&this._append(t),this._doFinalize()},blockSize:16,_createHelper:function(t){return function(o,c){return new t.init(c).finalize(o)}},_createHmacHelper:function(t){return function(o,c){return new v.HMAC.init(t,c).finalize(o)}}});var v=s.algo={};return s}(Math);(function(i){for(var e=A,t=e.lib,s=t.WordArray,r=t.Hasher,t=e.algo,l=[],a=[],f=function(c){return 4294967296*(c-(c|0))|0},p=2,h=0;64>h;){var d;t:{d=p;for(var S=i.sqrt(d),x=2;x<=S;x++)if(!(d%x)){d=!1;break t}d=!0}d&&(8>h&&(l[h]=f(i.pow(p,.5))),a[h]=f(i.pow(p,1/3)),h++),p++}var v=[],t=t.SHA256=r.extend({_doReset:function(){this._hash=new s.init(l.slice(0))},_doProcessBlock:function(o,c){for(var n=this._hash.words,u=n[0],w=n[1],g=n[2],M=n[3],m=n[4],O=n[5],D=n[6],R=n[7],_=0;64>_;_++){if(16>_)v[_]=o[c+_]|0;else{var y=v[_-15],P=v[_-2];v[_]=((y<<25|y>>>7)^(y<<14|y>>>18)^y>>>3)+v[_-7]+((P<<15|P>>>17)^(P<<13|P>>>19)^P>>>10)+v[_-16]}y=R+((m<<26|m>>>6)^(m<<21|m>>>11)^(m<<7|m>>>25))+(m&O^~m&D)+a[_]+v[_],P=((u<<30|u>>>2)^(u<<19|u>>>13)^(u<<10|u>>>22))+(u&w^u&g^w&g),R=D,D=O,O=m,m=M+y|0,M=g,g=w,w=u,u=y+P|0}n[0]=n[0]+u|0,n[1]=n[1]+w|0,n[2]=n[2]+g|0,n[3]=n[3]+M|0,n[4]=n[4]+m|0,n[5]=n[5]+O|0,n[6]=n[6]+D|0,n[7]=n[7]+R|0},_doFinalize:function(){var o=this._data,c=o.words,n=8*this._nDataBytes,u=8*o.sigBytes;return c[u>>>5]|=128<<24-u%32,c[(u+64>>>9<<4)+14]=i.floor(n/4294967296),c[(u+64>>>9<<4)+15]=n,o.sigBytes=4*c.length,this._process(),this._hash},clone:function(){var o=r.clone.call(this);return o._hash=this._hash.clone(),o}});e.SHA256=r._createHelper(t),e.HmacSHA256=r._createHmacHelper(t)})(Math),function(){var i=A,e=i.enc.Utf8;i.algo.HMAC=i.lib.Base.extend({init:function(s,r){s=this._hasher=new s.init,typeof r=="string"&&(r=e.parse(r));var l=s.blockSize,a=4*l;r.sigBytes>a&&(r=s.finalize(r)),r.clamp();for(var f=this._oKey=r.clone(),p=this._iKey=r.clone(),h=f.words,d=p.words,S=0;S<l;S++)h[S]^=1549556828,d[S]^=909522486;f.sigBytes=p.sigBytes=a,this.reset()},reset:function(){var s=this._hasher;s.reset(),s.update(this._iKey)},update:function(s){return this._hasher.update(s),this},finalize:function(s){var r=this._hasher;return s=r.finalize(s),r.reset(),r.finalize(this._oKey.clone().concat(s))}})}();const C=A.HmacSHA256,Y=function(){let i=new Date().getTime();return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(e){let s=(i+Math.random()*16)%16|0;return i=Math.floor(i/16),(e=="x"?s:s&3|8).toString(16)})},K=(i,e)=>{const s=["token","deviceId","appId","platform","reportTime"].sort().filter(r=>i[r]).map(r=>r+"="+i[r]).join("&");return C("POST"+s,e).toString()},H=(i,e)=>{let s;const r={"Y+":e.getFullYear().toString(),"M+":(e.getMonth()+1).toString(),"D+":e.getDate().toString(),"H+":e.getHours().toString(),"m+":e.getMinutes().toString(),"s+":e.getSeconds().toString(),"S+":e.getMilliseconds.toString()};for(let l in r)s=new RegExp("("+l+")").exec(i),s&&(i=i.replace(s[1],s[1].length==1?r[l]:r[l].padStart(s[1].length,"0")));return i},z=()=>new Date().getTime()+""+Math.floor(Math.random()*10);var W=Object.defineProperty,L=Object.defineProperties,N=Object.getOwnPropertyDescriptors,U=Object.getOwnPropertySymbols,j=Object.prototype.hasOwnProperty,J=Object.prototype.propertyIsEnumerable,k=(i,e,s)=>e in i?W(i,e,{enumerable:!0,configurable:!0,writable:!0,value:s}):i[e]=s,$=(i,e)=>{for(var s in e||(e={}))j.call(e,s)&&k(i,s,e[s]);if(U)for(var s of U(e))J.call(e,s)&&k(i,s,e[s]);return i},q=(i,e)=>L(i,N(e)),V=(i,e,s)=>new Promise((r,l)=>{var a=h=>{try{p(s.next(h))}catch(d){l(d)}},f=h=>{try{p(s.throw(h))}catch(d){l(d)}},p=h=>h.done?r(h.value):Promise.resolve(h.value).then(a,f);p((s=s.apply(i,e)).next())});class X{constructor(e){this.clientInfo=e,this.baseUrl=E(e.isDev||!1).BASE_URL}getTokenResp(e){return V(this,null,function*(){try{let s=this.baseUrl+I.getWsToken,r={orderId:e,appId:this.clientInfo.appId,huifuId:this.clientInfo.huifuId,channel:this.clientInfo.channel,reqDate:H("YYYY-MM-DD HH:mm:ss",new Date),reqSeqId:z()},l=this.getSign(r),a=yield I.post(s,q($({},r),{sign:l}));return a.code==="90000"&&a.data?a.data.wsToken||"":(console.log("ws token error"+a.message),a.message)}catch{return console.log("ws token error"),"token error"}})}getSign(e){let s=Object.keys(e).sort().filter(r=>e[r]).map(r=>r+"="+e[r]).join("&");return C(s,this.clientInfo.appSecret).toString()}}class G{constructor(e){this.initPrams=e}track(e){if(!this.initPrams)return;const{appId:s,isDev:r}=this.initPrams,l=Date.now(),a={appId:"fone-hfpush-sdk",deviceId:Y(),token:E(r||!1).POSTBE_APP_TOKEN,platform:"3",reportTime:l,sensorData:[{sensorNo:"0100_00007911_\u7EDF\u4E00\u63A8\u9001WebSocket\u901A\u77E5\u63A5\u6536\u56DE\u6267",actionType:2,page:"",occurTime:l,sensorAttr:{messageId:e.messageId,orderId:e.orderId,appId:s}}]};console.log(">>>TRACK_DATA>>>",a),a.sign=K(a,E(r||!1).POSTBE_APP_KEY),I.post(E(r||!1).POSTBE_URL,a).then(f=>{f.respCode==="90000"?console.log("post be save succeeded"):console.log("post be save error: "+f.respDesc)}).catch(f=>{console.log("post be save error: "+f)})}}var Q=(i,e,s)=>new Promise((r,l)=>{var a=h=>{try{p(s.next(h))}catch(d){l(d)}},f=h=>{try{p(s.throw(h))}catch(d){l(d)}},p=h=>h.done?r(h.value):Promise.resolve(h.value).then(a,f);p((s=s.apply(i,e)).next())});class Z{constructor(e){this.version=F,this.clientInfo=e,this.ws={},this.http=new X(e),this.orderId="",this.monitorInfo={appId:e.appId,isDev:e.isDev},this.monitor=new G(this.monitorInfo)}connect(e){return Q(this,null,function*(){typeof WebSocket>"u"&&console.log("\u5F53\u524D\u73AF\u5883\u4E0D\u652F\u6301 Websocket \u901A\u4FE1\u534F\u8BAE");const{isDev:s}=this.clientInfo;let r=yield this.http.getTokenResp(e);const l=E(s||!1).WEBSOCKET_URL,a=new WebSocket(l+r);a.onmessage=this.ws.onmessage,a.onopen=this.ws.onopen,a.onclose=this.ws.onclose,a.onerror=this.ws.onerror,this.orderId=e,this.ws=a})}get wsStatus(){return this.ws.readyState===1}onOpen(e){this.ws.onopen=()=>{e&&e()}}onMessage(e){this.ws.onmessage=({data:s})=>{let r=JSON.parse(s);this.monitor.track({messageId:r.messageId,orderId:this.orderId});let l=new Date;this.send({messageId:r.messageId,serverSendTime:r.serverSendTime,clientRecTime:H("YYYY-MM-DD HH:mm:ss:SSS",l),relayTime:H("YYYY-MM-DD HH:mm:ss:SSS",l)}),e&&e(r)}}onClose(e){this.ws.onclose=()=>{this.ws.onmessage=null,this.ws.onopen=null,this.ws.onclose=null,this.ws.onerror=null,e&&e()}}onError(e){this.ws.onerror=()=>{e&&e()}}once(e){this.onMessage(s=>{this.onClose(void 0),e&&e(s)})}send(e){this.ws.send(e)}}return Z});
